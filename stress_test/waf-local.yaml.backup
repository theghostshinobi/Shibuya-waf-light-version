# ============================================
# File: config/waf-local.yaml
# ============================================
# LOCAL config for Stress Test

# Network Configuration
server:
  listen_addr: "0.0.0.0"
  http_port: 9090
  https_port: 8443
  shutdown_timeout: 30s
  request_timeout: 60s
  max_connections: 50000

  tls:
    enabled: false
    cert_path: "certs/server.crt"
    key_path: "certs/server.key"
    min_version: "TLS1.3"
    cipher_suites:
      - "TLS_AES_256_GCM_SHA384"
      - "TLS_AES_128_GCM_SHA256"
      - "TLS_CHACHA20_POLY1305_SHA256"

# Upstream Backend (Vulnerable App on Localhost)
upstream:
  backend_url: "http://127.0.0.1:8081"
  pool_size: 200
  connect_timeout: 5s
  request_timeout: 30s
  idle_timeout: 90s

  health_check:
    enabled: true
    path: "/health"
    interval: 10s
    timeout: 3s
    unhealthy_threshold: 3
    healthy_threshold: 2

# Security Pipeline
detection:
  enabled: true
  mode: blocking # off | detection | blocking

  # Aggregated Score Thresholds
  blocking_threshold: 25 # e.g., 5 CRS matches
  challenge_threshold: 15 # e.g., 3 CRS matches or 1 ML anomaly

  crs:
    enabled: true
    rules_path: "rules/crs"
    paranoia_level: 1 # 1-4
    inbound_threshold: 5
    outbound_threshold: 4

  rate_limiting:
    enabled: true
    requests_per_second: 100
    burst_size: 200
    ban_duration_secs: 300

# Machine Learning Engine
ml:
  enabled: true
  model_path: "ml/models/isolation_forest.onnx"
  classifier_model_path: "ml/models/attack_classifier.onnx"
  scaler_path: "ml/models/scaler.json"
  threshold: 0.7
  inference_threads: 4
  cache_features: true
  ml_weight: 0.3
  shadow_mode: false
  fail_open: true

threat_intel:
  enabled: true
  cache_ttl_hours: 24
  score_threshold: 70

  feeds:
    # Static file with malicious IPs (one per line)
    - name: "custom_blacklist"
      source_type: "StaticFile"
      file_path: "./data/blacklist.txt"
      update_interval_hours: 24
      enabled: true

    # Tor exit nodes
    - name: "tor_exit_nodes"
      source_type: "TorExitNodes"
      update_interval_hours: 6
      enabled: true

# System Telemetry
telemetry:
  log_level: "info"
  log_format: "json"
  metrics_enabled: true
  metrics_port: 9091
  tracing_enabled: true
  tracing_sample_rate: 0.05

# Hard Security Limits
security:
  max_body_size: 10485760 # 10MB
  max_header_size: 16384 # 16KB
  max_uri_length: 4096 # 4KB
  allowed_methods:
    - GET
    - POST
    - PUT
    - DELETE
    - HEAD
    - OPTIONS
    - PATCH
  blocked_user_agents:
    - "nessus"
    - "nmap"
    - "nikto"
    - "curl" # Strict example
