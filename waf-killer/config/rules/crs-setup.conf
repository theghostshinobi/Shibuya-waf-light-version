# ============================================
# File: config/rules/crs-setup.conf
# ============================================
# Core Rule Set Configuration
# Based on OWASP CRS v4
# ------------------------------------------------------------------------

# ------------------------------------------------------------------------
# 0. System Defaults
# ------------------------------------------------------------------------
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# ------------------------------------------------------------------------
# 1. SQL Injection Rules
# ------------------------------------------------------------------------
# Rule 942100: SQL Injection Attack Detected via libinjection
# Tests:
# - id=1' union select 1,2,3--
# - admin' --
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS:User-Agent|REQUEST_HEADERS:Referer|REQUEST_HEADERS:X-Forwarded-For \
    "@detectSQLi" \
    "id:942100,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack Detected via libinjection',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    tag:'paranoia-level/1',\
    tag:'OWASP_CRS',\
    tag:'capec/1000/152/248/66',\
    tag:'PCI/6.5.2',\
    ver:'OWASP_CRS/3.3.0',\
    severity:'CRITICAL',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# Rule 942110: SQL Injection Attack Detected via common keywords
# Tests:
# - id=1 OR 1=1
# - id=1 AND 1=1
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS:User-Agent|REQUEST_HEADERS:Referer|REQUEST_HEADERS:X-Forwarded-For \
    "(?i:(\b(?:(?:s(?:elect\b(?:.{1,100}?\b(?:(?:length|count|top)\b|from\b|into\b|all\b|distinct\b|users?\b|pwd\b|pass(?:word)?\b))?|chema\b)|u(?:nion\b|pdate\b)|d(?:rop\b|elete\b)|i(?:nsert\b|nformation_schema\b))|w(?:here\b|aitfor\b)|group\b\s+by\b|order\b\s+by\b|having\b|limit\b|offset\b))" \
    "id:942110,\
    phase:2,\
    block,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'SQL Injection Attack Detected via keywords',\
    severity:'CRITICAL'"

# ------------------------------------------------------------------------
# 2. XSS Rules
# ------------------------------------------------------------------------
# Rule 941100: XSS Attack Detected via libinjection
# Tests:
# - <script>alert(1)</script>
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS:User-Agent|REQUEST_HEADERS:Referer|REQUEST_HEADERS:X-Forwarded-For \
    "@detectXSS" \
    "id:941100,\
    phase:2,\
    block,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:removeNulls,\
    msg:'XSS Attack Detected via libinjection',\
    severity:'CRITICAL'"

# Rule 941110: XSS Filter - Script Tag
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY \
    "(?i)<script[^>]*>[\s\S]*?" \
    "id:941110,\
    phase:2,\
    block,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,\
    msg:'XSS Filter - Script Tag',\
    severity:'CRITICAL'"

# ------------------------------------------------------------------------
# 3. Remote Command Execution
# ------------------------------------------------------------------------
# Rule 932100: Remote Command Execution: Unix Command Injection
# Tests:
# - ; cat /etc/passwd
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|REQUEST_BODY \
    "(?i)(?:;|\||\|\||&&|\n|\r|\$\(|\`)\s*(?:cat|nc|netcat|wget|curl|bash|sh|python|perl|php|ruby|gcc|whoami|id|uname|pwd)\b" \
    "id:932100,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'RCE: Unix Command Injection',\
    severity:'CRITICAL'"
